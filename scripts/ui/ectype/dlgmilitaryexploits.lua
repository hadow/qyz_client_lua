local unpack        = unpack
local print         = print
local uimanager     = require"uimanager"
local EventHelper   = UIEventListenerHelper

local name,gameObject,fields

local scores
local isattacker
local statisticMsg

local function destroy()

end

local function hide()

end

local function udpate()

end

local function ShowFamilyNames(allyname,enemyname)

end

local function CmpFamilyMembers(a,b)
    if a.damage == b.damage then
        if a.kill == b.kill then
            return a.dead < b.dead
        else
            return a.kill > b.kill
        end
    else
        return a.damage > b.damage
    end
end

local function FamilyTeams(msgTeam)
  local ret = {}
  for _,team in pairs(msgTeam) do
      local teamInfo = {}
      teamInfo.dmg = 0
      -- teamInfo.heal = 0
      teamInfo.isRoleTeam = false
      teamInfo.members = {}
      -- teamInfo.towerInfo = msgTeam.towerinfo
      for _,memberInfo in pairs(team.members) do
          teamInfo.dmg = memberInfo.damage + teamInfo.dmg
          -- teamInfo.heal = memberInfo.heal + teamInfo.heal
          if memberInfo.name == PlayerRole.Instance().m_Name then
              memberInfo.isRole = true
              teamInfo.isRoleTeam = true
          end
          table.insert(teamInfo.members,memberInfo)
      end
      table.sort(teamInfo.members,CmpFamilyMembers)
      table.insert(ret,teamInfo)
  end
  table.sort(ret,function(a,b) return a.isRoleTeam end)
  return ret
end

local function ShowFamilyArenaTeam(item,team)
    local memberList = item.Controls["UIList_Ranklist"]
    memberList:ResetListCount(#team.members)
    for i=1,#team.members do
        local member = team.members[i]
        local memberItem = memberList:GetItemByIndex(i-1)
        memberItem.Controls["UISprite_ONE"].spriteName = "Sprite_Rank_" .. tostring(i>3 and 4 or i)
        memberItem.Controls["UILabel_Num"].text  = i>3 and tostring(i) or ""
        memberItem.Controls["UILabel_Name"].text = member.name
        memberItem.Controls["UILabel_Hurt"].text = string.format("%d%%",math.floor(member.damage*100/team.dmg))
        memberItem.Controls["UILabel_Kill"].text = string.format("%d/%d",member.kill,member.dead)
    end
end

local function EnterEctype()
    InitScore()
end

local function show(params)
    scores = params.scores
    isattacker = params.isattacker
    statisticMsg = params.statisticMsg
    enemyfamilyid = params.enemyfamilyid
    fields.UILabel_MyFamilyName.text = PlayerRole.Instance().m_FamilyName
    fields.UILabel_EnemyFamilyName.text = ""
    local enemyscore = isattacker and scores.attackscore   or scores.defencescore
    local allyscore  = isattacker and scores.defencescore  or scores.attackscore
    fields.UILabel_MyFamilyIntegral.text      = tostring(allyscore)
    fields.UILabel_EnemyFamilyIntegral.text   = tostring(enemyscore)

    local teams = FamilyTeams(statisticMsg.teams)
    fields.UIList_Team:ResetListCount(#teams)
    for i=1,#teams do
        local team = teams[i]
        local teamItem = fields.UIList_Team:GetItemByIndex(i-1)
        ShowFamilyArenaTeam(teamItem,team)
    end

    EventHelper.SetClick(fields.UISprite_CloseResult,function()
        uimanager.hidedialog(name)
        if params.callback then
            params.callback()
        end
    end)

end

local function refresh(params)

end

local function init(params)
    name,gameObject,fields = unpack(params)
end

return {
    init            = init,
    refresh         = refresh,
    show            = show,
    update          = update,
    hide            = hide,
    destroy         = destroy,
}
